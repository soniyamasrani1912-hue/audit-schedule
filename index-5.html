<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agile Ceremony Scheduler</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --lowes-blue: #004990;
      --lowes-light: #15b6e5;
      --lowes-orange: #FF6600;
      --bg-light: #f0f4f8;
      --event-kickoff: #FFF7A3;
      --event-retro: #C6F6D5;
      --event-backlog: #E0E7FF;
      --event-pov: #E9D5FF;
      --event-planning: #FFE4C4;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg-light) 0%, #e8eef5 100%);
      min-height: 100vh;
    }

    header {
      background: linear-gradient(90deg, var(--lowes-blue) 0%, #003d70 100%);
      color: #ffffff;
      padding: 16px 30px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 4px 12px rgba(0, 73, 144, 0.25);
      border-bottom: 4px solid var(--lowes-orange);
    }

    header img { height: 48px; width: auto; }

    .header-content { display: flex; flex-direction: column; gap: 2px; }

    header h1 {
      font-size: 28px;
      margin: 0;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    header p { font-size: 12px; opacity: 0.9; margin: 0; }

    main {
      padding: 30px;
      max-width: 1400px;
      margin: 24px auto;
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 12px;
      border-left: 5px solid var(--lowes-orange);
    }

    label {
      display: inline-block;
      width: 170px;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--lowes-blue);
    }

    input, select {
      margin-bottom: 8px;
      padding: 8px 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--lowes-blue);
      box-shadow: 0 0 0 3px rgba(0, 73, 144, 0.1);
    }

    .button {
      margin-top: 10px;
      margin-right: 8px;
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      color: #fff;
      background: var(--lowes-blue);
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 73, 144, 0.2);
    }

    .button:hover {
      background: #003d70;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 73, 144, 0.3);
    }

    .button.secondary { background: var(--lowes-light); color: #00324f; }
    .button.secondary:hover { background: #0d9dc4; }

    .button.success { background: #22c55e; color: white; }
    .button.success:hover { background: #16a34a; }

    h2 {
      margin-top: 24px;
      color: var(--lowes-blue);
      font-size: 22px;
      padding-bottom: 10px;
      border-bottom: 3px solid var(--lowes-orange);
      display: inline-block;
    }

    h3 { color: var(--lowes-blue); margin-top: 16px; }

    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: 100%;
      max-width: 1000px;
    }

    th, td {
      border: 1px solid #d0d4dd;
      padding: 12px;
      text-align: left;
      vertical-align: top;
      font-size: 13px;
    }

    th {
      background: linear-gradient(135deg, var(--lowes-blue), #003d70);
      color: white;
      font-weight: 600;
    }

    tr:nth-child(even) { background: #f9fafb; }
    tr:hover { background: #f0f4f8; }

    .month-container { margin-top: 20px; }
    .month-title {
      font-weight: bold;
      margin-top: 15px;
      color: #12324f;
      font-size: 16px;
      padding: 10px;
      background: rgba(0, 73, 144, 0.05);
      border-left: 4px solid var(--lowes-orange);
      border-radius: 4px;
    }

    .calendar-table {
      table-layout: fixed;
      width: 100%;
      max-width: 900px;
      background: #ffffff;
      border: 2px solid var(--lowes-blue);
      border-radius: 8px;
      overflow: hidden;
    }

    .calendar-table th {
      background: var(--lowes-blue);
      color: white;
      padding: 12px;
      text-align: center;
    }

    .calendar-table td {
      text-align: left;
      height: 120px;
      font-size: 11px;
      padding: 8px;
      vertical-align: top;
      border: 1px solid #e0e7ff;
    }

    .calendar-day {
      font-weight: bold;
      display: block;
      margin-bottom: 4px;
      color: var(--lowes-blue);
      font-size: 14px;
    }

    .event-label {
      display: block;
      font-size: 10px;
      border-radius: 3px;
      padding: 3px 5px;
      margin: 2px 0;
      color: #102a43;
      font-weight: 500;
      border-left: 3px solid #333;
    }

    .event-kickoff { background: var(--event-kickoff); border-left-color: #FFD700; }
    .event-retro { background: var(--event-retro); border-left-color: #4ade80; }
    .event-backlog { background: var(--event-backlog); border-left-color: #60a5fa; }
    .event-pov { background: var(--event-pov); border-left-color: #a78bfa; }
    .event-planning { background: var(--event-planning); border-left-color: #fb923c; }

    .leave-label {
      display: block;
      font-size: 9px;
      border-radius: 3px;
      padding: 2px 4px;
      margin: 2px 0;
      border: 1px solid #888;
      font-weight: bold;
      font-style: italic;
    }

    .holiday-label {
      display: block;
      font-size: 9px;
      border-radius: 3px;
      padding: 2px 4px;
      margin: 2px 0;
      border: 2px solid #8b3a00;
      font-weight: bold;
      background: #ffd4a3;
      color: #8b3a00;
    }

    .legend {
      margin-top: 16px;
      font-size: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      padding: 16px;
      background: rgba(0, 73, 144, 0.05);
      border-radius: 8px;
      border-left: 4px solid var(--lowes-orange);
    }

    .legend-item { display: flex; align-items: center; gap: 8px; }
    .legend-color { width: 16px; height: 16px; border-radius: 3px; border: 1px solid #999; }

    .section-card {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      border: 2px solid #e5e7eb;
      border-left: 5px solid var(--lowes-orange);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .section-card h2 { margin-top: 0; border-bottom: none; }

    .section-card p {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
    }

    .team-member-row,
    .leave-row,
    .holiday-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: flex-start;
      background: #fff;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      flex-wrap: wrap;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .team-member-row input,
    .leave-row input,
    .leave-row select,
    .holiday-row input {
      margin-bottom: 0;
      padding: 6px 8px;
      font-size: 12px;
    }

    .team-member-row label,
    .leave-row label,
    .holiday-row label {
      width: auto;
      margin-bottom: 0;
      font-size: 12px;
      margin-right: 4px;
    }

    .team-member-group,
    .leave-group,
    .holiday-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .remove-btn {
      padding: 6px 10px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      align-self: center;
      transition: background 0.3s;
    }

    .remove-btn:hover { background: #dc2626; }

    .add-member-btn {
      padding: 10px 16px;
      background: #22c55e;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      margin-top: 8px;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(34, 197, 94, 0.2);
    }

    .add-member-btn:hover {
      background: #16a34a;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(34, 197, 94, 0.3);
    }

    .no-members-message {
      font-size: 12px;
      color: #999;
      font-style: italic;
      padding: 12px;
      background: #f3f4f6;
      border-radius: 4px;
      border-left: 3px solid var(--lowes-orange);
    }
  </style>
</head>
<body>
  <header>
    <img src="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/6c9c13ed-a9d0-4844-8847-87fcea5d1318.png" alt="Lowe's Logo" style="filter: brightness(1.2);">
    <div class="header-content">
      <h1>Agile Ceremony Scheduler</h1>
      <p>Lowe's Audit Planning & Coordination</p>
    </div>
  </header>

  <main>
    <!-- SECTION 1: AUDIT SCHEDULE -->
    <section class="section-card">
      <h2>Audit Schedule Setup</h2>
      <div>
        <label for="auditTitle">Audit Title:</label>
        <input type="text" id="auditTitle" placeholder="E.g., Q1 2025 Store Audit" style="width: 300px;">
      </div>
      <div>
        <label for="startDate">Audit start date:</label>
        <input type="date" id="startDate">
      </div>
      <div>
        <label for="sprintCount">Number of sprints:</label>
        <input type="number" id="sprintCount" min="1" value="2">
      </div>

      <button class="button" id="generateBtn">Generate Schedule</button>
      <button class="button secondary" id="downloadExcelCalendarBtn">Download Calendar (Excel)</button>
      <button class="button success" id="downloadIcsBtn">Add to Outlook (ICS)</button>
      <button class="button secondary" id="resetBtn">Reset Planner</button>

      <div class="legend">
        <div class="legend-item">
          <span class="legend-color" style="background: var(--event-kickoff);"></span> <strong>Kickoff</strong>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: var(--event-planning);"></span> <strong>Sprint Planning</strong>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: var(--event-backlog);"></span> <strong>Backlog Refinement</strong>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: var(--event-pov);"></span> <strong>POV</strong>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: var(--event-retro);"></span> <strong>Retrospective</strong>
        </div>
      </div>
    </section>

    <!-- SECTION 2: TEAM MEMBERS -->
    <section class="section-card">
      <h2>Team Members</h2>
      <p>Add team members with their emails (up to 10 members). These emails will receive ceremony invitations.</p>
      <div id="teamMembersContainer"></div>
      <button class="add-member-btn" id="addTeamMemberBtn">+ Add Team Member</button>
    </section>

    <!-- SECTION 3: LEAVE PLANNING -->
    <section class="section-card">
      <h2>Leave Planning</h2>
      <p>Select team members and mark their leave dates (up to 10 leave entries)</p>
      <div id="leavePlaceholder" class="no-members-message">Add team members first to plan leaves</div>
      <div id="leavesContainer"></div>
      <button class="add-member-btn" id="addLeaveBtn" style="display:none;">+ Add Leave</button>
    </section>

    <!-- SECTION 4: PUBLIC HOLIDAYS -->
    <section class="section-card">
      <h2>Public Holidays</h2>
      <p>Add public holidays (up to 10 holidays)</p>
      <div id="holidaysContainer"></div>
      <button class="add-member-btn" id="addHolidayBtn">+ Add Holiday</button>
    </section>

    <section>
      <h2>Tabular Schedule</h2>
      <div id="schedule"></div>
    </section>

    <section>
      <h2>Calendar View</h2>
      <div id="calendarView"></div>
    </section>
  </main>

  <script>
    const teamMemberColors = [
      '#fca5a5', '#fed7aa', '#fef3c7', '#bfdbfe', '#bfb5ff',
      '#d8b4fe', '#f0abfc', '#fbcfe8', '#a7f3d0', '#86efac'
    ];

    function addDays(d, days) {
      const date = new Date(d.getTime());
      date.setDate(date.getDate() + days);
      return date;
    }

    function formatDate(d) {
      return d.toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function formatDateISO(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      const seconds = String(d.getSeconds()).padStart(2, '0');
      return `${year}${month}${day}T${hours}${minutes}${seconds}`;
    }

    function weekdayName(d) {
      return d.toLocaleDateString(undefined, { weekday: 'long' });
    }

    function getEventClass(eventName) {
      const lower = eventName.toLowerCase();
      if (lower.includes('kickoff')) return 'event-kickoff';
      if (lower.includes('retrospective')) return 'event-retro';
      if (lower.includes('backlog')) return 'event-backlog';
      if (lower.includes('pov')) return 'event-pov';
      if (lower.includes('planning')) return 'event-planning';
      return '';
    }

    let lastRows = [];
    let teamMembers = [];
    let leaves = [];
    let holidays = [];
    let auditTitle = '';

    // -------- Team Members ----------
    function initializeTeamMembers() {
      const container = document.getElementById('teamMembersContainer');
      container.innerHTML = '';
      teamMembers = [];
      addTeamMember();
    }

    function addTeamMember() {
      if (teamMembers.length >= 10) {
        alert('Maximum 10 team members allowed.');
        return;
      }

      const index = teamMembers.length;
      const member = { name: '', email: '', color: teamMemberColors[index] };
      teamMembers.push(member);

      const container = document.getElementById('teamMembersContainer');
      const row = document.createElement('div');
      row.className = 'team-member-row';
      row.id = 'member-' + index;

      row.innerHTML = `
        <div class="team-member-group">
          <div>
            <label>Name:</label>
            <input type="text" placeholder="Team member name"
                   data-index="${index}"
                   class="team-member-name"
                   style="width: 140px;">
          </div>
        </div>
        <div class="team-member-group">
          <div>
            <label>Email:</label>
            <input type="email" placeholder="email@company.com"
                   data-index="${index}"
                   class="team-member-email"
                   style="width: 180px;">
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; height: 30px;">
          <div style="width: 20px; height: 20px; background: ${member.color}; border-radius: 3px; border: 1px solid #999;"></div>
          ${teamMembers.length > 1 ? `<button class="remove-btn" onclick="removeTeamMember(${index})">Remove</button>` : ''}
        </div>
      `;

      container.appendChild(row);

      row.querySelector('.team-member-name').addEventListener('change', function() {
        teamMembers[index].name = this.value;
        refreshLeaveDropdowns();
      });

      row.querySelector('.team-member-email').addEventListener('change', function() {
        teamMembers[index].email = this.value;
      });

      updateAddButton('addTeamMemberBtn', teamMembers.length);
      refreshLeaveDropdowns();
    }

    function removeTeamMember(index) {
      const row = document.getElementById('member-' + index);
      if (row) row.remove();
      teamMembers.splice(index, 1);
      updateAddButton('addTeamMemberBtn', teamMembers.length);
      refreshLeaveDropdowns();
    }

    // -------- Leaves ----------
    function initializeLeaves() {
      const container = document.getElementById('leavesContainer');
      container.innerHTML = '';
      leaves = [];

      const hasTeamMembers = teamMembers.some(m => m.name);
      const placeholder = document.getElementById('leavePlaceholder');
      const addBtn = document.getElementById('addLeaveBtn');

      if (!hasTeamMembers) {
        placeholder.style.display = 'block';
        addBtn.style.display = 'none';
      }
    }

    function addLeave() {
      const hasTeamMembers = teamMembers.some(m => m.name);
      if (!hasTeamMembers) {
        alert('Please add team members first.');
        return;
      }

      if (leaves.length >= 10) {
        alert('Maximum 10 leave entries allowed.');
        return;
      }

      const index = leaves.length;
      const leave = { teamMemberId: '', fromDate: '', toDate: '' };
      leaves.push(leave);

      const container = document.getElementById('leavesContainer');
      const row = document.createElement('div');
      row.className = 'leave-row';
      row.id = 'leave-' + index;

      let memberOptions = '<option value="">-- Select Team Member --</option>';
      teamMembers.forEach((member, idx) => {
        if (member.name) {
          memberOptions += `<option value="${idx}">${member.name}</option>`;
        }
      });

      row.innerHTML = `
        <div class="leave-group">
          <div>
            <label>Team Member:</label>
            <select class="leave-member-select" data-index="${index}" style="width: 150px;">
              ${memberOptions}
            </select>
          </div>
        </div>
        <div class="leave-group">
          <div>
            <label>Leave From:</label>
            <input type="date" class="leave-from-date" data-index="${index}">
          </div>
        </div>
        <div class="leave-group">
          <div>
            <label>Leave To:</label>
            <input type="date" class="leave-to-date" data-index="${index}">
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; height: 30px;">
          ${leaves.length > 1 ? `<button class="remove-btn" onclick="removeLeave(${index})">Remove</button>` : ''}
        </div>
      `;

      container.appendChild(row);

      row.querySelector('.leave-member-select').addEventListener('change', function() {
        leaves[index].teamMemberId = this.value;
      });

      row.querySelector('.leave-from-date').addEventListener('change', function() {
        leaves[index].fromDate = this.value;
      });

      row.querySelector('.leave-to-date').addEventListener('change', function() {
        leaves[index].toDate = this.value;
      });

      updateAddButton('addLeaveBtn', leaves.length);
    }

    function removeLeave(index) {
      const row = document.getElementById('leave-' + index);
      if (row) row.remove();
      leaves.splice(index, 1);
      updateAddButton('addLeaveBtn', leaves.length);
    }

    function refreshLeaveDropdowns() {
      const hasTeamMembers = teamMembers.some(m => m.name);
      const placeholder = document.getElementById('leavePlaceholder');
      const addBtn = document.getElementById('addLeaveBtn');

      if (hasTeamMembers) {
        placeholder.style.display = 'none';
        addBtn.style.display = 'inline-block';
      } else {
        placeholder.style.display = 'block';
        addBtn.style.display = 'none';
      }

      document.querySelectorAll('.leave-member-select').forEach(select => {
        const currentValue = select.value;
        let memberOptions = '<option value="">-- Select Team Member --</option>';
        teamMembers.forEach((member, idx) => {
          if (member.name) {
            memberOptions += `<option value="${idx}">${member.name}</option>`;
          }
        });
        select.innerHTML = memberOptions;
        select.value = currentValue;
      });
    }

    // -------- Holidays ----------
    function initializeHolidays() {
      const container = document.getElementById('holidaysContainer');
      container.innerHTML = '';
      holidays = [];
      addHoliday();
    }

    function addHoliday() {
      if (holidays.length >= 10) {
        alert('Maximum 10 holidays allowed.');
        return;
      }

      const index = holidays.length;
      const holiday = { name: '', date: '' };
      holidays.push(holiday);

      const container = document.getElementById('holidaysContainer');
      const row = document.createElement('div');
      row.className = 'holiday-row';
      row.id = 'holiday-' + index;

      row.innerHTML = `
        <div class="holiday-group">
          <div>
            <label>Holiday Name:</label>
            <input type="text" placeholder="E.g., Independence Day"
                   data-index="${index}"
                   class="holiday-name"
                   style="width: 180px;">
          </div>
        </div>
        <div class="holiday-group">
          <div>
            <label>Date:</label>
            <input type="date" data-index="${index}" class="holiday-date">
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; height: 30px;">
          <div style="width: 20px; height: 20px; background: #ffd4a3; border-radius: 3px; border: 1px solid #8b3a00;"></div>
          ${holidays.length > 1 ? `<button class="remove-btn" onclick="removeHoliday(${index})">Remove</button>` : ''}
        </div>
      `;

      container.appendChild(row);

      row.querySelector('.holiday-name').addEventListener('change', function() {
        holidays[index].name = this.value;
      });

      row.querySelector('.holiday-date').addEventListener('change', function() {
        holidays[index].date = this.value;
      });

      updateAddButton('addHolidayBtn', holidays.length);
    }

    function removeHoliday(index) {
      const row = document.getElementById('holiday-' + index);
      if (row) row.remove();
      holidays.splice(index, 1);
      updateAddButton('addHolidayBtn', holidays.length);
    }

    function updateAddButton(btnId, count) {
      const btn = document.getElementById(btnId);
      if (count >= 10) {
        btn.disabled = true;
        btn.style.opacity = '0.5';
      } else {
        btn.disabled = false;
        btn.style.opacity = '1';
      }
    }

    // -------- Schedule ----------
    function generateSchedule(startDate, sprintCount) {
      const rows = [];
      let sprintStart = new Date(startDate.getTime());

      for (let s = 0; s < sprintCount; s++) {
        if (s === 0) {
          const kickoff = sprintStart;
          rows.push({ sprint: 0, event: 'Audit Kickoff', date: kickoff });

          const br = addDays(sprintStart, 6);
          rows.push({ sprint: 0, event: 'Backlog Refinement', date: br });

          const retro = addDays(sprintStart, 14);
          rows.push({ sprint: 0, event: 'Retrospective', date: retro });

          sprintStart = retro;
        } else {
          const planning = sprintStart;
          rows.push({ sprint: s, event: 'Sprint Planning', date: planning });

          const br = addDays(sprintStart, 6);
          rows.push({ sprint: s, event: 'Backlog Refinement', date: br });

          const pov = addDays(sprintStart, 13);
          rows.push({ sprint: s, event: 'POV Sprint ' + s, date: pov });

          const retro = addDays(sprintStart, 14);
          rows.push({ sprint: s, event: 'Retrospective', date: retro });

          sprintStart = retro;
        }
      }

      return rows;
    }

    function renderTable(rows) {
      if (!rows.length) return '<p>No schedule generated yet.</p>';

      let html = '<table><thead><tr>' +
                 '<th>Audit Title</th><th>Sprint</th><th>Event</th><th>Date</th><th>Day</th>' +
                 '</tr></thead><tbody>';

      rows.forEach(r => {
        const cls = getEventClass(r.event);
        html += '<tr>' +
                '<td>' + auditTitle + '</td>' +
                '<td>' + r.sprint + '</td>' +
                '<td class="' + cls + '">' + r.event + '</td>' +
                '<td>' + formatDate(r.date) + '</td>' +
                '<td>' + weekdayName(r.date) + '</td>' +
                '</tr>';
      });

      html += '</tbody></table>';
      return html;
    }

    // -------- Calendar helpers ----------
    function dateKey(d) {
      return d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
    }

    function buildEventsByDate(rows) {
      const map = {};
      rows.forEach(r => {
        const key = dateKey(r.date);
        if (!map[key]) map[key] = [];
        map[key].push(r);
      });
      return map;
    }

    function buildLeavesByDate() {
      const map = {};
      leaves.forEach(leave => {
        if (!leave.teamMemberId || !leave.fromDate || !leave.toDate) return;

        const memberIdx = parseInt(leave.teamMemberId);
        const member = teamMembers[memberIdx];
        if (!member) return;

        const from = new Date(leave.fromDate);
        const to = new Date(leave.toDate);

        for (let d = new Date(from); d <= to; d = addDays(d, 1)) {
          const key = dateKey(d);
          if (!map[key]) map[key] = [];
          map[key].push(member);
        }
      });
      return map;
    }

    function buildHolidaysByDate() {
      const map = {};
      holidays.forEach(holiday => {
        if (!holiday.date || !holiday.name) return;

        const holidayDate = new Date(holiday.date);
        const key = dateKey(holidayDate);
        if (!map[key]) map[key] = [];
        map[key].push(holiday);
      });
      return map;
    }

    function renderMonthCalendar(year, monthIndex, eventsByDate, leavesByDate, holidaysByDate) {
      const monthStart = new Date(year, monthIndex, 1);
      const monthEnd = new Date(year, monthIndex + 1, 0);
      const firstWeekday = monthStart.getDay();
      const daysInMonth = monthEnd.getDate();

      let html = '<div class="month-container">';
      html += '<div class="month-title">' +
              monthStart.toLocaleDateString(undefined, { month: 'long', year: 'numeric' }) +
              '</div>';

      html += '<table class="calendar-table"><thead><tr>';
      const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      weekdays.forEach(w => { html += '<th>' + w + '</th>'; });
      html += '</tr></thead><tbody><tr>';

      let day = 1;
      for (let i = 0; i < firstWeekday; i++) html += '<td></td>';

      let weekday = firstWeekday;
      while (day <= daysInMonth) {
        if (weekday === 7) {
          html += '</tr><tr>';
          weekday = 0;
        }

        const currentDate = new Date(year, monthIndex, day);
        const key = dateKey(currentDate);
        html += '<td>';
        html += '<span class="calendar-day">' + day + '</span>';

        if (eventsByDate[key]) {
          eventsByDate[key].forEach(ev => {
            const cls = getEventClass(ev.event);
            const displayText = auditTitle ? auditTitle + ' || S' + ev.sprint + ': ' + ev.event : 'S' + ev.sprint + ': ' + ev.event;
            html += '<span class="event-label ' + cls + '">' + displayText + '</span>';
          });
        }

        if (leavesByDate[key]) {
          leavesByDate[key].forEach(member => {
            html += '<span class="leave-label" style="background: ' + member.color + ';">' + member.name + ' ON LEAVE</span>';
          });
        }

        if (holidaysByDate[key]) {
          holidaysByDate[key].forEach(holiday => {
            html += '<span class="holiday-label">' + holiday.name + '</span>';
          });
        }

        html += '</td>';
        day++;
        weekday++;
      }

      while (weekday > 0 && weekday < 7) {
        html += '<td></td>';
        weekday++;
      }

      html += '</tr></tbody></table></div>';
      return html;
    }

    function renderCalendarView(rows, leavesByDate, holidaysByDate) {
      if (!rows.length && Object.keys(leavesByDate).length === 0 && Object.keys(holidaysByDate).length === 0) {
        return '<p>No schedule, leaves, or holidays planned yet.</p>';
      }

      const eventsByDate = buildEventsByDate(rows);

      let minDate = new Date();
      let maxDate = new Date();

      if (rows.length > 0) {
        minDate = rows[0].date;
        maxDate = rows[0].date;
        rows.forEach(r => {
          if (r.date < minDate) minDate = r.date;
          if (r.date > maxDate) maxDate = r.date;
        });
      }

      leaves.forEach(leave => {
        if (leave.fromDate) {
          const from = new Date(leave.fromDate);
          const to = leave.toDate ? new Date(leave.toDate) : from;
          if (from < minDate) minDate = from;
          if (to > maxDate) maxDate = to;
        }
      });

      holidays.forEach(holiday => {
        if (holiday.date) {
          const holidayDate = new Date(holiday.date);
          if (holidayDate < minDate) minDate = holidayDate;
          if (holidayDate > maxDate) maxDate = holidayDate;
        }
      });

      let html = '';
      let year = minDate.getFullYear();
      let month = minDate.getMonth();
      const endYear = maxDate.getFullYear();
      const endMonth = maxDate.getMonth();

      while (year < endYear || (year === endYear && month <= endMonth)) {
        html += renderMonthCalendar(year, month, eventsByDate, leavesByDate, holidaysByDate);
        month++;
        if (month === 12) { month = 0; year++; }
      }

      return html;
    }

    // -------- Excel calendar export ----------
    function generateCalendarExcel(rows) {
      const eventsByDate = buildEventsByDate(rows);
      const leavesByDate = buildLeavesByDate();
      const holidaysByDate = buildHolidaysByDate();

      let minDate = new Date();
      let maxDate = new Date();

      if (rows.length > 0) {
        minDate = rows[0].date;
        maxDate = rows[0].date;
        rows.forEach(r => {
          if (r.date < minDate) minDate = r.date;
          if (r.date > maxDate) maxDate = r.date;
        });
      }

      const workbook = XLSX.utils.book_new();

      const colors = {
        kickoff: 'FFF7A3',
        retrospective: 'C6F6D5',
        backlog: 'E0E7FF',
        pov: 'E9D5FF',
        planning: 'FFE4C4',
        leave: 'FFCCCC',
        holiday: 'FFD4A3',
        light: 'F5F5F5'
      };

      let year = minDate.getFullYear();
      let month = minDate.getMonth();
      const endYear = maxDate.getFullYear();
      const endMonth = maxDate.getMonth();

      while (year < endYear || (year === endYear && month <= endMonth)) {
        const monthStart = new Date(year, month, 1);
        const monthEnd = new Date(year, month + 1, 0);
        const firstWeekday = monthStart.getDay();
        const daysInMonth = monthEnd.getDate();

        const sheetName = monthStart.toLocaleDateString(undefined, { month: 'short', year: '2-digit' });

        const data = [];
        const cellStyles = [];

        const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        data.push(weekdays);

        for (let i = 0; i < 7; i++) {
          if (!cellStyles[0]) cellStyles[0] = [];
          cellStyles[0][i] = {
            fill: { fgColor: { rgb: '004990' } },
            font: { bold: true, color: { rgb: 'FFFFFF' } },
            alignment: { horizontal: 'center', vertical: 'center' },
            border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } }
          };
        }

        let day = 1;
        let weekday = firstWeekday;
        let currentWeek = new Array(7).fill('');
        let dataRowIdx = 1;

        for (let i = 0; i < firstWeekday; i++) currentWeek[i] = '';

        while (day <= daysInMonth) {
          const currentDate = new Date(year, month, day);
          const key = dateKey(currentDate);
          let cellContent = day.toString();
          let cellColor = colors.light;

          if (eventsByDate[key]) {
            eventsByDate[key].forEach(ev => {
              cellContent += '\n' + ev.event;
              if (ev.event.includes('Audit Kickoff')) cellColor = colors.kickoff;
              else if (ev.event.includes('Retrospective')) cellColor = colors.retrospective;
              else if (ev.event.includes('Backlog Refinement')) cellColor = colors.backlog;
              else if (ev.event.includes('POV')) cellColor = colors.pov;
              else if (ev.event.includes('Sprint Planning')) cellColor = colors.planning;
            });
          }

          if (leavesByDate[key]) {
            leavesByDate[key].forEach(member => {
              cellContent += '\n' + member.name + ' ON LEAVE';
              cellColor = colors.leave;
            });
          }

          if (holidaysByDate[key]) {
            holidaysByDate[key].forEach(holiday => {
              cellContent += '\n' + holiday.name;
              cellColor = colors.holiday;
            });
          }

          currentWeek[weekday] = cellContent;

          if (weekday === 6 || day === daysInMonth) {
            data.push([...currentWeek]);

            if (!cellStyles[dataRowIdx]) cellStyles[dataRowIdx] = [];
            for (let colIdx = 0; colIdx < 7; colIdx++) {
              let rowColor = colors.light;
              const rowContent = currentWeek[colIdx];

              if (rowContent) {
                if (rowContent.includes('Audit Kickoff')) rowColor = colors.kickoff;
                else if (rowContent.includes('Retrospective')) rowColor = colors.retrospective;
                else if (rowContent.includes('Backlog Refinement')) rowColor = colors.backlog;
                else if (rowContent.includes('POV')) rowColor = colors.pov;
                else if (rowContent.includes('Sprint Planning')) rowColor = colors.planning;
                else if (rowContent.includes('ON LEAVE')) rowColor = colors.leave;
              }

              cellStyles[dataRowIdx][colIdx] = {
                fill: { fgColor: { rgb: rowColor } },
                alignment: { vertical: 'top', wrapText: true },
                border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } }
              };
            }

            if (day < daysInMonth) currentWeek = new Array(7).fill('');
            dataRowIdx++;
          }

          day++;
          weekday++;
          if (weekday === 7) weekday = 0;
        }

        const worksheet = XLSX.utils.aoa_to_sheet(data);
        worksheet['!cols'] = [{ wch: 22 },{ wch: 22 },{ wch: 22 },{ wch: 22 },{ wch: 22 },{ wch: 22 },{ wch: 22 }];
        worksheet['!rows'] = [];
        for (let i = 0; i < data.length; i++) worksheet['!rows'][i] = { hpx: i === 0 ? 28 : 110 };

        for (let rowIdx = 0; rowIdx < data.length; rowIdx++) {
          for (let colIdx = 0; colIdx < 7; colIdx++) {
            const cellRef = XLSX.utils.encode_cell({ r: rowIdx, c: colIdx });
            if (!worksheet[cellRef]) worksheet[cellRef] = { v: data[rowIdx][colIdx] || '' };
            if (cellStyles[rowIdx] && cellStyles[rowIdx][colIdx]) worksheet[cellRef].s = cellStyles[rowIdx][colIdx];
          }
        }

        XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);

        month++;
        if (month === 12) { month = 0; year++; }
      }

      XLSX.writeFile(workbook, 'audit_calendar.xlsx');
    }

    // -------- ICS Export ----------
    function rowsToICS(rows) {
      if (!rows.length) return '';

      const validAttendees = teamMembers.filter(tm => tm.email && tm.name);

      let ics = 'BEGIN:VCALENDAR\n';
      ics += 'VERSION:2.0\n';
      ics += 'PRODID:-//Lowe\'s Audit//Agile Ceremonies Scheduler//EN\n';
      ics += 'CALSCALE:GREGORIAN\n';
      ics += 'METHOD:PUBLISH\n';

      rows.forEach((r, index) => {
        const startDate = new Date(r.date);
        startDate.setHours(9, 0, 0);
        const endDate = new Date(startDate);
        endDate.setHours(10, 0, 0);

        const uid = 'audit-ceremony-' + index + '-' + Date.now() + '@lowes.com';
        const dtstamp = formatDateISO(new Date());
        const dtstart = formatDateISO(startDate);
        const dtend = formatDateISO(endDate);
        const summary = auditTitle ? auditTitle + ' || Sprint ' + r.sprint + ': ' + r.event : 'Sprint ' + r.sprint + ': ' + r.event;
        const description = auditTitle ? auditTitle + ' - ' + r.event + ' for Sprint ' + r.sprint : 'Audit Agile Ceremony - ' + r.event + ' for Sprint ' + r.sprint;

        ics += 'BEGIN:VEVENT\n';
        ics += 'UID:' + uid + '\n';
        ics += 'DTSTAMP:' + dtstamp + '\n';
        ics += 'DTSTART:' + dtstart + '\n';
        ics += 'DTEND:' + dtend + '\n';
        ics += 'SUMMARY:' + summary + '\n';
        ics += 'DESCRIPTION:' + description + '\n';

        validAttendees.forEach(attendee => {
          ics += 'ATTENDEE;ROLE=REQ-PARTICIPANT;PARTSTAT=NEEDS-ACTION;RSVP=TRUE;CN=' + attendee.name + ':mailto:' + attendee.email + '\n';
        });

        ics += 'STATUS:CONFIRMED\n';
        ics += 'SEQUENCE:0\n';
        ics += 'END:VEVENT\n';
      });

      ics += 'END:VCALENDAR';
      return ics;
    }

    function downloadICS(filename, content) {
      try {
        const blob = new Blob([content], { type: 'text/calendar;charset=utf-8;' });
        if (window.navigator && window.navigator.msSaveOrOpenBlob) {
          window.navigator.msSaveOrOpenBlob(blob, filename);
          return;
        }
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error('ICS download failed', e);
        alert('Could not start ICS download in this environment.');
      }
    }

    // -------- Reset ----------
    function resetPlanner() {
      if (!confirm('This will clear the entire planner (schedule, team, leaves, holidays). Continue?')) return;

      document.getElementById('auditTitle').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('sprintCount').value = 2;

      document.getElementById('schedule').innerHTML = '';
      document.getElementById('calendarView').innerHTML = '';

      lastRows = [];
      teamMembers = [];
      leaves = [];
      holidays = [];

      initializeTeamMembers();
      initializeLeaves();
      initializeHolidays();
    }

    // -------- Event listeners ----------
    document.getElementById('generateBtn').addEventListener('click', function() {
      auditTitle = document.getElementById('auditTitle').value;
      const startInput = document.getElementById('startDate').value;
      const countInput = parseInt(document.getElementById('sprintCount').value, 10);

      if (!startInput || isNaN(countInput) || countInput < 1) {
        alert('Please enter a valid start date and number of sprints.');
        return;
      }

      const startDate = new Date(startInput);
      const rows = generateSchedule(startDate, countInput);
      lastRows = rows;

      document.getElementById('schedule').innerHTML = renderTable(rows);

      const leavesByDate = buildLeavesByDate();
      const holidaysByDate = buildHolidaysByDate();
      document.getElementById('calendarView').innerHTML = renderCalendarView(rows, leavesByDate, holidaysByDate);
    });

    document.getElementById('downloadExcelCalendarBtn').addEventListener('click', function() {
      if (!lastRows.length) {
        alert('Please generate a schedule first.');
        return;
      }
      generateCalendarExcel(lastRows);
    });

    document.getElementById('downloadIcsBtn').addEventListener('click', function() {
      if (!lastRows.length) {
        alert('Please generate a schedule first.');
        return;
      }
      const ics = rowsToICS(lastRows);
      downloadICS('audit_agile_ceremonies.ics', ics);
    });

    document.getElementById('resetBtn').addEventListener('click', resetPlanner);
    document.getElementById('addTeamMemberBtn').addEventListener('click', addTeamMember);
    document.getElementById('addLeaveBtn').addEventListener('click', addLeave);
    document.getElementById('addHolidayBtn').addEventListener('click', addHoliday);

    // Initial setup
    initializeTeamMembers();
    initializeLeaves();
    initializeHolidays();
  </script>
</body>
</html>
